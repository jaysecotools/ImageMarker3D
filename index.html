<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360° Image Marker Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* [KEEP ALL YOUR EXISTING STYLES HERE - DON'T CHANGE THEM] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { display: flex; flex-direction: column; height: 100vh; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #e6e6e6; overflow: hidden; }
        .header { background: rgba(0, 0, 0, 0.7); padding: 15px 20px; border-bottom: 2px solid #00b4d8; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .header h1 { color: #00b4d8; font-size: 1.8rem; }
        .header h1 i { margin-right: 10px; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .left-panel { width: 320px; background: rgba(30, 30, 46, 0.9); padding: 20px; overflow-y: auto; border-right: 1px solid #444; flex-shrink: 0; }
        .panel-section { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #444; }
        .panel-section h3 { color: #00b4d8; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .upload-area { border: 3px dashed #00b4d8; border-radius: 10px; padding: 30px 20px; text-align: center; cursor: pointer; transition: all 0.3s; background: rgba(0, 180, 216, 0.05); margin-bottom: 20px; }
        .upload-area:hover { background: rgba(0, 180, 216, 0.1); border-color: #90e0ef; }
        .upload-area i { font-size: 48px; color: #00b4d8; margin-bottom: 15px; }
        .upload-area p { margin: 10px 0; }
        .upload-area .file-info { font-size: 0.9rem; color: #aaa; }
        .button { display: block; width: 100%; padding: 12px; margin: 10px 0; border: none; border-radius: 6px; background: #00b4d8; color: white; font-weight: bold; cursor: pointer; transition: all 0.3s; text-align: center; }
        .button:hover { background: #0077b6; transform: translateY(-2px); }
        .button.secondary { background: #444; }
        .button.secondary:hover { background: #555; }
        .button.danger { background: #e63946; }
        .button.danger:hover { background: #d00000; }
        .button i { margin-right: 8px; }
        .marker-form input, .marker-form textarea, .marker-form select { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #555; border-radius: 4px; background: rgba(255, 255, 255, 0.1); color: white; }
        .marker-form textarea { height: 80px; resize: vertical; }
        .marker-type-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .marker-type { padding: 10px; border: 2px solid transparent; border-radius: 6px; text-align: center; cursor: pointer; transition: all 0.2s; background: rgba(255, 255, 255, 0.05); }
        .marker-type.selected { border-color: #00b4d8; background: rgba(0, 180, 216, 0.1); }
        .marker-type i { font-size: 20px; margin-bottom: 5px; display: block; }
        .marker-type.info { color: #4cc9f0; }
        .marker-type.link { color: #4361ee; }
        .marker-type.video { color: #f72585; }
        .marker-type.audio { color: #7209b7; }
        .marker-type.warning { color: #f8961e; }
        .marker-type.question { color: #2a9d8f; }
        .marker-list { max-height: 300px; overflow-y: auto; }
        .marker-item { background: rgba(255, 255, 255, 0.05); border-left: 4px solid #00b4d8; padding: 12px; margin-bottom: 10px; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .marker-item:hover { background: rgba(255, 255, 255, 0.1); }
        .marker-item.selected { background: rgba(0, 180, 216, 0.15); }
        .marker-item-header { display: flex; justify-content: space-between; align-items: center; }
        .marker-item-title { font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .marker-item-type { font-size: 0.8rem; padding: 2px 8px; border-radius: 10px; background: rgba(255, 255, 255, 0.1); }
        .marker-item-description { font-size: 0.9rem; color: #aaa; margin-top: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .viewer-container { flex: 1; position: relative; overflow: hidden; }
        #viewer { width: 100%; height: 100%; }
        .viewer-overlay { position: absolute; top: 20px; left: 20px; z-index: 10; }
        .viewer-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 10; }
        .control-btn { background: rgba(0, 0, 0, 0.7); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: all 0.3s; }
        .control-btn:hover { background: rgba(0, 180, 216, 0.8); transform: scale(1.1); }
        .instructions { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(0, 0, 0, 0.8); padding: 30px; border-radius: 10px; max-width: 500px; z-index: 5; }
        .instructions h3 { color: #00b4d8; margin-bottom: 15px; }
        .hidden { display: none !important; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .modal { background: #1a1a2e; padding: 30px; border-radius: 10px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; border: 2px solid #00b4d8; }
        .modal h3 { color: #00b4d8; margin-bottom: 20px; text-align: center; }
        .modal textarea { width: 100%; height: 400px; padding: 15px; background: rgba(255, 255, 255, 0.05); border: 1px solid #444; border-radius: 5px; color: white; font-family: monospace; font-size: 12px; margin-bottom: 20px; resize: none; white-space: pre; overflow-x: auto; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; }
        @media (max-width: 1024px) { .main-container { flex-direction: column; } .left-panel { width: 100%; max-height: 40vh; } }
        @media (max-width: 768px) { .header { flex-direction: column; gap: 10px; text-align: center; } .marker-type-selector { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-globe-americas"></i> 360° Image Marker Tool</h1>
        <div class="header-controls">
            <button class="button secondary" id="exportBtn">
                <i class="fas fa-file-export"></i> Export as HTML
            </button>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="panel-section">
                <h3><i class="fas fa-upload"></i> Upload 360° Image</h3>
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Click or drag & drop to upload 360° image</p>
                    <p class="file-info">Supported: JPG, PNG (Equirectangular format)</p>
                    <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.webp" style="display: none;">
                </div>
                <div id="imageInfo" class="hidden">
                    <p><strong>Current Image:</strong> <span id="currentImageName">None</span></p>
                    <p><strong>Markers:</strong> <span id="markerCount">0</span></p>
                </div>
            </div>

            <div class="panel-section">
                <h3><i class="fas fa-map-marker-alt"></i> Add Marker</h3>
                <button class="button" id="addMarkerBtn">
                    <i class="fas fa-plus-circle"></i> Add Marker at Current View
                </button>
                
                <div class="marker-form" id="markerForm">
                    <div class="marker-type-selector" id="markerTypeSelector">
                        <div class="marker-type info selected" data-type="info"><i class="fas fa-info-circle"></i><span>Info</span></div>
                        <div class="marker-type link" data-type="link"><i class="fas fa-link"></i><span>Link</span></div>
                        <div class="marker-type video" data-type="video"><i class="fas fa-video"></i><span>Video</span></div>
                        <div class="marker-type audio" data-type="audio"><i class="fas fa-volume-up"></i><span>Audio</span></div>
                        <div class="marker-type warning" data-type="warning"><i class="fas fa-exclamation-triangle"></i><span>Warning</span></div>
                        <div class="marker-type question" data-type="question"><i class="fas fa-question-circle"></i><span>Question</span></div>
                    </div>
                    
                    <input type="text" id="markerTitle" placeholder="Marker Title" maxlength="50">
                    <textarea id="markerDescription" placeholder="Description (optional)"></textarea>
                    <input type="text" id="markerUrl" placeholder="URL (for links/media)" class="hidden">
                    
                    <div class="form-buttons">
                        <button class="button" id="saveMarkerBtn"><i class="fas fa-save"></i> Save Marker</button>
                        <button class="button secondary" id="cancelMarkerBtn"><i class="fas fa-times"></i> Cancel</button>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <h3><i class="fas fa-list"></i> Markers (<span id="markerListCount">0</span>)</h3>
                <input type="text" id="markerSearch" placeholder="Search markers..." style="width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 4px; background: rgba(255, 255, 255, 0.1); border: 1px solid #555; color: white;">
                <div class="marker-list" id="markerList"></div>
                <button class="button danger" id="clearMarkersBtn"><i class="fas fa-trash"></i> Clear All Markers</button>
            </div>

            <div class="panel-section">
                <h3><i class="fas fa-cogs"></i> Viewer Controls</h3>
                <button class="button secondary" id="resetViewBtn"><i class="fas fa-redo"></i> Reset View</button>
                <button class="button secondary" id="autoRotateBtn"><i class="fas fa-sync"></i> Toggle Auto-Rotate</button>
            </div>
        </div>

        <div class="viewer-container">
            <div id="viewer"></div>
            
            <div class="instructions" id="instructions">
                <i class="fas fa-globe-americas" style="font-size: 48px; color: #00b4d8; margin-bottom: 20px;"></i>
                <h3>Welcome to the 360° Image Marker Tool</h3>
                <p>1. Upload a 360° panoramic image (equirectangular format)</p>
                <p>2. Use mouse/touch to look around the 3D space</p>
                <p>3. Click "Add Marker at Current View" to place markers</p>
                <p>4. Customize markers with titles, descriptions, and URLs</p>
                <p>5. Export as a standalone HTML file for any device</p>
            </div>
            
            <div class="viewer-overlay">
                <div class="viewer-controls">
                    <button class="control-btn" id="addMarkerQuickBtn" title="Add Marker">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay hidden" id="exportModal">
        <div class="modal">
            <h3><i class="fas fa-file-export"></i> Export as Standalone HTML</h3>
            <p>Copy the code below and save it as an HTML file. It contains everything needed to view your 360° image with markers on any device (PC, mobile, VR).</p>
            <textarea id="exportCode" readonly></textarea>
            <div class="modal-buttons">
                <button class="button" id="copyCodeBtn"><i class="fas fa-copy"></i> Copy Code</button>
                <button class="button secondary" id="downloadBtn"><i class="fas fa-download"></i> Download HTML File</button>
                <button class="button secondary" id="closeExportBtn"><i class="fas fa-times"></i> Close</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let scene, camera, renderer, sphere;
        let markers = [];
        let currentMarker = null;
        let selectedMarkerType = 'info';
        let autoRotate = false;
        let currentImageName = '';
        let currentImageDataUrl = '';

        const markerTypes = {
            info: { color: 0x4cc9f0, icon: 'fa-info-circle' },
            link: { color: 0x4361ee, icon: 'fa-link' },
            video: { color: 0xf72585, icon: 'fa-video' },
            audio: { color: 0x7209b7, icon: 'fa-volume-up' },
            warning: { color: 0xf8961e, icon: 'fa-exclamation-triangle' },
            question: { color: 0x2a9d8f, icon: 'fa-question-circle' }
        };

        function init() {
            setupEventListeners();
            initThreeJS();
            updateMarkerList();
        }

        function setupEventListeners() {
            document.getElementById('uploadArea').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            
            // Drag and drop
            document.getElementById('uploadArea').addEventListener('dragover', (e) => {
                e.preventDefault();
                e.currentTarget.style.borderColor = '#90e0ef';
                e.currentTarget.style.background = 'rgba(0, 180, 216, 0.15)';
            });
            document.getElementById('uploadArea').addEventListener('dragleave', (e) => {
                e.currentTarget.style.borderColor = '#00b4d8';
                e.currentTarget.style.background = 'rgba(0, 180, 216, 0.05)';
            });
            document.getElementById('uploadArea').addEventListener('drop', (e) => {
                e.preventDefault();
                e.currentTarget.style.borderColor = '#00b4d8';
                e.currentTarget.style.background = 'rgba(0, 180, 216, 0.05)';
                if (e.dataTransfer.files.length) handleFileSelect(e.dataTransfer.files[0]);
            });

            // Marker type selection
            document.querySelectorAll('.marker-type').forEach(type => {
                type.addEventListener('click', function() {
                    document.querySelectorAll('.marker-type').forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedMarkerType = this.dataset.type;
                    const urlField = document.getElementById('markerUrl');
                    if (selectedMarkerType === 'link' || selectedMarkerType === 'video' || selectedMarkerType === 'audio') {
                        urlField.classList.remove('hidden');
                    } else {
                        urlField.classList.add('hidden');
                    }
                });
            });

            // Buttons
            document.getElementById('addMarkerBtn').addEventListener('click', addMarkerAtCurrentView);
            document.getElementById('addMarkerQuickBtn').addEventListener('click', addMarkerAtCurrentView);
            document.getElementById('saveMarkerBtn').addEventListener('click', saveMarker);
            document.getElementById('cancelMarkerBtn').addEventListener('click', cancelMarker);
            document.getElementById('clearMarkersBtn').addEventListener('click', clearAllMarkers);
            document.getElementById('resetViewBtn').addEventListener('click', resetView);
            document.getElementById('autoRotateBtn').addEventListener('click', toggleAutoRotate);
            document.getElementById('exportBtn').addEventListener('click', showExportModal);
            document.getElementById('copyCodeBtn').addEventListener('click', copyExportCode);
            document.getElementById('downloadBtn').addEventListener('click', downloadExportFile);
            document.getElementById('closeExportBtn').addEventListener('click', () => {
                document.getElementById('exportModal').classList.add('hidden');
            });
            document.getElementById('markerSearch').addEventListener('input', updateMarkerList);
        }

        function initThreeJS() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 0.1);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(document.getElementById('viewer').offsetWidth, document.getElementById('viewer').offsetHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('viewer').appendChild(renderer.domElement);
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            createSphere('https://images.unsplash.com/photo-1519681393784-d120267933ba?w=2048&h=1024&fit=crop');
            setupControls();
            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function createSphere(imageUrl) {
            if (sphere) {
                scene.remove(sphere);
                sphere.geometry.dispose();
                sphere.material.dispose();
            }
            
            const geometry = new THREE.SphereGeometry(500, 60, 40);
            geometry.scale(-1, 1, 1);
            
            const texture = new THREE.TextureLoader().load(imageUrl, () => {
                document.getElementById('instructions').classList.add('hidden');
            }, undefined, (error) => {
                console.error('Error loading image:', error);
                alert('Error loading image. Please make sure it\'s a valid image file.');
            });
            
            const material = new THREE.MeshBasicMaterial({ map: texture });
            sphere = new THREE.Mesh(geometry, material);
            scene.add(sphere);
        }

        function setupControls() {
            let isMouseDown = false;
            let previousMousePosition = { x: 0, y: 0 };
            const viewer = document.getElementById('viewer');
            
            viewer.addEventListener('mousedown', (e) => {
                isMouseDown = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            viewer.addEventListener('mousemove', (e) => {
                if (!isMouseDown) return;
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;
                camera.rotation.y -= deltaX * 0.005;
                camera.rotation.x -= deltaY * 0.005;
                camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            viewer.addEventListener('mouseup', () => { isMouseDown = false; });
            viewer.addEventListener('wheel', (e) => {
                const zoomFactor = 1 + e.deltaY * 0.001;
                camera.fov *= zoomFactor;
                camera.fov = Math.max(30, Math.min(120, camera.fov));
                camera.updateProjectionMatrix();
            });
            
            // Touch support
            viewer.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    isMouseDown = true;
                    previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
            });
            viewer.addEventListener('touchmove', (e) => {
                if (!isMouseDown || e.touches.length !== 1) return;
                e.preventDefault();
                const deltaX = e.touches[0].clientX - previousMousePosition.x;
                const deltaY = e.touches[0].clientY - previousMousePosition.y;
                camera.rotation.y -= deltaX * 0.005;
                camera.rotation.x -= deltaY * 0.005;
                camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
                previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            });
            viewer.addEventListener('touchend', () => { isMouseDown = false; });
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) handleFileSelect(file);
        }

        function handleFileSelect(file) {
            if (!file.type.match('image.*')) {
                alert('Please select an image file (JPG, PNG, etc.)');
                return;
            }
            
            currentImageName = file.name;
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageDataUrl = e.target.result;
                createSphere(currentImageDataUrl);
                document.getElementById('currentImageName').textContent = currentImageName;
                document.getElementById('imageInfo').classList.remove('hidden');
                document.getElementById('instructions').classList.add('hidden');
                markers.forEach(marker => scene.remove(marker.object));
                markers = [];
                updateMarkerList();
            };
            reader.onerror = function() { alert('Error reading file. Please try again.'); };
            reader.readAsDataURL(file);
        }

        function addMarkerAtCurrentView() {
            if (!currentImageDataUrl) {
                alert('Please upload an image first.');
                return;
            }
            
            const distance = 450;
            const vector = new THREE.Vector3(0, 0, -1);
            vector.applyEuler(camera.rotation);
            vector.multiplyScalar(distance);
            
            currentMarker = {
                id: Date.now(),
                type: selectedMarkerType,
                title: `Marker ${markers.length + 1}`,
                description: '',
                url: '',
                position: vector.toArray()
            };
            
            document.getElementById('markerTitle').value = currentMarker.title;
            document.getElementById('markerDescription').value = '';
            document.getElementById('markerUrl').value = '';
            document.getElementById('markerForm').classList.remove('hidden');
            document.getElementById('markerTitle').focus();
        }

        function saveMarker() {
            const title = document.getElementById('markerTitle').value.trim();
            const description = document.getElementById('markerDescription').value.trim();
            const url = document.getElementById('markerUrl').value.trim();
            
            if (!title) {
                alert('Please enter a marker title.');
                return;
            }
            
            currentMarker.title = title;
            currentMarker.description = description;
            currentMarker.url = url;
            
            const geometry = new THREE.SphereGeometry(10, 16, 16);
            const material = new THREE.MeshBasicMaterial({ 
                color: markerTypes[currentMarker.type].color,
                transparent: true,
                opacity: 0.8
            });
            const markerObject = new THREE.Mesh(geometry, material);
            markerObject.position.set(...currentMarker.position);
            markerObject.userData = { markerId: currentMarker.id };
            scene.add(markerObject);
            
            currentMarker.object = markerObject;
            markers.push(currentMarker);
            cancelMarker();
            updateMarkerList();
        }

        function cancelMarker() {
            currentMarker = null;
            document.getElementById('markerForm').classList.add('hidden');
            document.getElementById('markerTitle').value = '';
            document.getElementById('markerDescription').value = '';
            document.getElementById('markerUrl').value = '';
        }

        function updateMarkerList() {
            const markerList = document.getElementById('markerList');
            const searchTerm = document.getElementById('markerSearch').value.toLowerCase();
            const filteredMarkers = markers.filter(marker => 
                marker.title.toLowerCase().includes(searchTerm) ||
                marker.description.toLowerCase().includes(searchTerm) ||
                marker.type.includes(searchTerm)
            );
            
            markerList.innerHTML = '';
            filteredMarkers.forEach(marker => {
                const markerItem = document.createElement('div');
                markerItem.className = 'marker-item';
                markerItem.innerHTML = `
                    <div class="marker-item-header">
                        <div class="marker-item-title">
                            <i class="fas ${markerTypes[marker.type].icon}"></i>
                            ${marker.title}
                        </div>
                        <span class="marker-item-type">${marker.type}</span>
                    </div>
                    <div class="marker-item-description">${marker.description || 'No description'}</div>
                `;
                markerItem.addEventListener('click', () => {
                    const markerObj = marker.object;
                    if (markerObj) {
                        const markerPosition = markerObj.position.clone();
                        const direction = markerPosition.clone().normalize();
                        camera.position.copy(direction.multiplyScalar(0.1));
                        camera.lookAt(markerObj.position);
                    }
                    showMarkerInfo(marker);
                });
                markerList.appendChild(markerItem);
            });
            
            document.getElementById('markerCount').textContent = markers.length;
            document.getElementById('markerListCount').textContent = markers.length;
        }

        function showMarkerInfo(marker) {
            let info = `<strong>${marker.title}</strong><br><em>Type: ${marker.type}</em><br><br>${marker.description || 'No description'}<br><br>`;
            if (marker.url) {
                if (marker.type === 'link') info += `<a href="${marker.url}" target="_blank">Open Link</a>`;
                else if (marker.type === 'video') info += `<a href="${marker.url}" target="_blank">Watch Video</a>`;
                else if (marker.type === 'audio') info += `<a href="${marker.url}" target="_blank">Play Audio</a>`;
            }
            alert(info);
        }

        function clearAllMarkers() {
            if (markers.length === 0) return;
            if (confirm(`Are you sure you want to remove all ${markers.length} markers?`)) {
                markers.forEach(marker => {
                    scene.remove(marker.object);
                    marker.object.geometry.dispose();
                    marker.object.material.dispose();
                });
                markers = [];
                updateMarkerList();
            }
        }

        function resetView() {
            camera.rotation.set(0, 0, 0);
            camera.fov = 75;
            camera.updateProjectionMatrix();
        }

        function toggleAutoRotate() {
            autoRotate = !autoRotate;
            const btn = document.getElementById('autoRotateBtn');
            btn.innerHTML = autoRotate ? 
                '<i class="fas fa-stop-circle"></i> Stop Auto-Rotate' : 
                '<i class="fas fa-sync"></i> Toggle Auto-Rotate';
        }

        function showExportModal() {
            if (!currentImageDataUrl) {
                alert('Please upload an image first.');
                return;
            }
            
            if (markers.length === 0) {
                if (!confirm('No markers added. Export image only?')) return;
            }
            
            document.getElementById('exportCode').value = generateExportCode();
            document.getElementById('exportModal').classList.remove('hidden');
        }

        // SIMPLE, FIXED EXPORT FUNCTION
        function generateExportCode() {
            const markerData = markers.map(marker => ({
                type: marker.type,
                title: marker.title,
                description: marker.description,
                url: marker.url,
                position: marker.position,
                color: markerTypes[marker.type].color
            }));
            
            // Simple HTML escape function
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            const safeImageName = escapeHtml(currentImageName);
            const markerJson = JSON.stringify(markerData);
            
            // Build the export HTML using string concatenation to avoid template literal issues
            return '<!DOCTYPE html>\n' +
'<html lang="en">\n' +
'<head>\n' +
'    <meta charset="UTF-8">\n' +
'    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
'    <title>360° Viewer: ' + safeImageName + '</title>\n' +
'    <style>\n' +
'        body { margin: 0; overflow: hidden; background: #000; }\n' +
'        canvas { display: block; }\n' +
'        .marker-info { \n' +
'            position: absolute; \n' +
'            bottom: 20px; \n' +
'            left: 20px; \n' +
'            background: rgba(0,0,0,0.8); \n' +
'            color: white; \n' +
'            padding: 15px; \n' +
'            border-radius: 5px;\n' +
'            max-width: 300px;\n' +
'            display: none;\n' +
'            border-left: 4px solid #00b4d8;\n' +
'        }\n' +
'        .marker-info a {\n' +
'            color: #4cc9f0;\n' +
'            text-decoration: none;\n' +
'            display: inline-block;\n' +
'            margin-top: 10px;\n' +
'        }\n' +
'        .instructions {\n' +
'            position: absolute;\n' +
'            top: 50%;\n' +
'            left: 50%;\n' +
'            transform: translate(-50%, -50%);\n' +
'            text-align: center;\n' +
'            background: rgba(0, 0, 0, 0.9);\n' +
'            color: white;\n' +
'            padding: 30px;\n' +
'            border-radius: 10px;\n' +
'            max-width: 500px;\n' +
'            border: 2px solid #00b4d8;\n' +
'        }\n' +
'        .hidden { display: none; }\n' +
'    </style>\n' +
'</head>\n' +
'<body>\n' +
'    <div id="container"></div>\n' +
'    <div id="markerInfo" class="marker-info"></div>\n' +
'    \n' +
'    <div class="instructions" id="instructions">\n' +
'        <h3 style="color: #00b4d8; margin-top: 0;">360° Image Viewer</h3>\n' +
'        <p><strong>' + safeImageName + '</strong></p>\n' +
'        <p>Drag to look around • Scroll to zoom</p>\n' +
'        <p>Click on markers for information</p>\n' +
'        <button id="startBtn" style="margin-top: 15px; padding: 10px 20px; background: #00b4d8; color: white; border: none; border-radius: 5px; cursor: pointer;">Start Exploring</button>\n' +
'    </div>\n' +
'\n' +
'    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"><\/script>\n' +
'    <script>\n' +
'        const scene = new THREE.Scene();\n' +
'        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);\n' +
'        const renderer = new THREE.WebGLRenderer({ antialias: true });\n' +
'        renderer.setSize(window.innerWidth, window.innerHeight);\n' +
'        document.getElementById("container").appendChild(renderer.domElement);\n' +
'        \n' +
'        const geometry = new THREE.SphereGeometry(500, 60, 40);\n' +
'        geometry.scale(-1, 1, 1);\n' +
'        \n' +
'        const textureLoader = new THREE.TextureLoader();\n' +
'        const texture = textureLoader.load("' + currentImageDataUrl + '", \n' +
'            function() {\n' +
'                document.getElementById("instructions").classList.remove("hidden");\n' +
'            },\n' +
'            undefined,\n' +
'            function(error) {\n' +
'                console.error("Error loading image:", error);\n' +
'            }\n' +
'        );\n' +
'        \n' +
'        const material = new THREE.MeshBasicMaterial({ map: texture });\n' +
'        const sphere = new THREE.Mesh(geometry, material);\n' +
'        scene.add(sphere);\n' +
'        \n' +
'        const markers = ' + markerJson + ';\n' +
'        \n' +
'        markers.forEach(marker => {\n' +
'            const markerGeometry = new THREE.SphereGeometry(10, 16, 16);\n' +
'            const markerMaterial = new THREE.MeshBasicMaterial({ \n' +
'                color: marker.color,\n' +
'                transparent: true,\n' +
'                opacity: 0.8\n' +
'            });\n' +
'            const markerObj = new THREE.Mesh(markerGeometry, markerMaterial);\n' +
'            markerObj.position.set(marker.position[0], marker.position[1], marker.position[2]);\n' +
'            markerObj.userData = marker;\n' +
'            scene.add(markerObj);\n' +
'        });\n' +
'        \n' +
'        camera.position.set(0, 0, 0.1);\n' +
'        \n' +
'        let isMouseDown = false;\n' +
'        let previousMousePosition = { x: 0, y: 0 };\n' +
'        \n' +
'        document.addEventListener("mousedown", (e) => {\n' +
'            isMouseDown = true;\n' +
'            previousMousePosition = { x: e.clientX, y: e.clientY };\n' +
'        });\n' +
'        \n' +
'        document.addEventListener("mousemove", (e) => {\n' +
'            if (!isMouseDown) return;\n' +
'            const deltaX = e.clientX - previousMousePosition.x;\n' +
'            const deltaY = e.clientY - previousMousePosition.y;\n' +
'            camera.rotation.y -= deltaX * 0.005;\n' +
'            camera.rotation.x -= deltaY * 0.005;\n' +
'            camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));\n' +
'            previousMousePosition = { x: e.clientX, y: e.clientY };\n' +
'        });\n' +
'        \n' +
'        document.addEventListener("mouseup", () => { isMouseDown = false; });\n' +
'        \n' +
'        document.addEventListener("wheel", (e) => {\n' +
'            const zoomFactor = 1 + e.deltaY * 0.001;\n' +
'            camera.fov *= zoomFactor;\n' +
'            camera.fov = Math.max(30, Math.min(120, camera.fov));\n' +
'            camera.updateProjectionMatrix();\n' +
'        });\n' +
'        \n' +
'        const raycaster = new THREE.Raycaster();\n' +
'        const mouse = new THREE.Vector2();\n' +
'        \n' +
'        function onMouseClick(event) {\n' +
'            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;\n' +
'            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;\n' +
'            raycaster.setFromCamera(mouse, camera);\n' +
'            const markerObjects = scene.children.filter(obj => obj !== sphere);\n' +
'            const intersects = raycaster.intersectObjects(markerObjects);\n' +
'            if (intersects.length > 0) {\n' +
'                const marker = intersects[0].object.userData;\n' +
'                const infoDiv = document.getElementById("markerInfo");\n' +
'                let content = "<strong>" + marker.title + "</strong><br>";\n' +
'                content += "<em>" + marker.type + "</em><br><br>";\n' +
'                content += marker.description || "No description";\n' +
'                if (marker.url) {\n' +
'                    content += "<br><br><a href=\\"" + marker.url + "\\" target=\\"_blank\\">";\n' +
'                    if (marker.type === "link") content += "Open Link";\n' +
'                    else if (marker.type === "video") content += "Watch Video";\n' +
'                    else if (marker.type === "audio") content += "Play Audio";\n' +
'                    content += "</a>";\n' +
'                }\n' +
'                infoDiv.innerHTML = content;\n' +
'                infoDiv.style.display = "block";\n' +
'                setTimeout(() => { infoDiv.style.display = "none"; }, 10000);\n' +
'            }\n' +
'        }\n' +
'        \n' +
'        document.addEventListener("click", onMouseClick);\n' +
'        \n' +
'        document.getElementById("startBtn").addEventListener("click", () => {\n' +
'            document.getElementById("instructions").classList.add("hidden");\n' +
'        });\n' +
'        \n' +
'        setTimeout(() => {\n' +
'            document.getElementById("instructions").classList.add("hidden");\n' +
'        }, 5000);\n' +
'        \n' +
'        window.addEventListener("resize", () => {\n' +
'            camera.aspect = window.innerWidth / window.innerHeight;\n' +
'            camera.updateProjectionMatrix();\n' +
'            renderer.setSize(window.innerWidth, window.innerHeight);\n' +
'        });\n' +
'        \n' +
'        function animate() {\n' +
'            requestAnimationFrame(animate);\n' +
'            renderer.render(scene, camera);\n' +
'        }\n' +
'        animate();\n' +
'    <\/script>\n' +
'</body>\n' +
'</html>';
        }

        function copyExportCode() {
            const exportCode = document.getElementById('exportCode');
            exportCode.select();
            exportCode.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                alert('Code copied to clipboard! Save it as an HTML file.');
            } catch (err) {
                console.error('Failed to copy: ', err);
                alert('Failed to copy code. Please select and copy manually.');
            }
        }

        function downloadExportFile() {
            const exportCode = document.getElementById('exportCode').value;
            const blob = new Blob([exportCode], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const safeFilename = currentImageName.replace(/\.[^/.]+$/, "") || 'export';
            a.download = `360-viewer-${safeFilename}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function onWindowResize() {
            camera.aspect = document.getElementById('viewer').offsetWidth / document.getElementById('viewer').offsetHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(document.getElementById('viewer').offsetWidth, document.getElementById('viewer').offsetHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (autoRotate) camera.rotation.y += 0.002;
            renderer.render(scene, camera);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
